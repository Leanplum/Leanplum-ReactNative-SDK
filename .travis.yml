if: (tag IS present) OR (type = pull_request)

language: node_js
node_js:
  - "18.20.8"

cache: yarn

before_script:
  - echo "=== TRAVIS BUILD DEBUG INFO ==="
  - echo "TRAVIS_BUILD_TYPE: $TRAVIS_EVENT_TYPE"
  - echo "TRAVIS_BRANCH: $TRAVIS_BRANCH"
  - echo "TRAVIS_TAG: $TRAVIS_TAG"
  - echo "TRAVIS_PULL_REQUEST: $TRAVIS_PULL_REQUEST"
  - echo "TRAVIS_PULL_REQUEST_BRANCH: $TRAVIS_PULL_REQUEST_BRANCH"
  - echo "TRAVIS_REPO_SLUG: $TRAVIS_REPO_SLUG"
  - |
    if [ "$TRAVIS_TAG" != "" ]; then
      echo "‚úÖ TAG IS PRESENT: $TRAVIS_TAG"
    else
      echo "‚ùå NO TAG PRESENT"
    fi
  - |
    if [ "$TRAVIS_EVENT_TYPE" = "pull_request" ]; then
      echo "üìù THIS IS A PULL REQUEST BUILD"
      echo "   - Source branch: $TRAVIS_PULL_REQUEST_BRANCH"
      echo "   - Target branch: $TRAVIS_BRANCH"
      echo "   - PR Number: $TRAVIS_PULL_REQUEST"
    else
      echo "üöÄ THIS IS A $TRAVIS_EVENT_TYPE BUILD"
    fi
  - |
    if [ "$TRAVIS_TAG" != "" ] || [ "$TRAVIS_EVENT_TYPE" = "pull_request" ]; then
      echo "‚úÖ IF CONDITION PASSED: Build will proceed"
    else
      echo "‚ùå IF CONDITION FAILED: Build should not have started"
      echo "   - Tag present: $([ "$TRAVIS_TAG" != "" ] && echo 'YES' || echo 'NO')"
      echo "   - Is pull request: $([ "$TRAVIS_EVENT_TYPE" = 'pull_request' ] && echo 'YES' || echo 'NO')"
    fi
  - echo "=== END DEBUG INFO ==="

script:
  - ./Tools/setLPAndroidVersion.sh
  - ./Tools/setLPiOSVersion.sh
  - yarn install --frozen-lockfile
#  - yarn test
  - yarn build

after_success:
  - ./Tools/createTag.sh
  
before_deploy: |
  echo "=== DEPLOYMENT DEBUG INFO ==="
  echo "DEPLOYMENT TRIGGERED!"
  echo "Current tag: $TRAVIS_TAG"
  echo "Current branch: $TRAVIS_BRANCH"
  echo "Is pull request: $TRAVIS_PULL_REQUEST"
  echo "Event type: $TRAVIS_EVENT_TYPE"
  
  if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then
    echo "‚ö†Ô∏è  WARNING: This is a pull request build - deployment will be skipped by Travis"
  fi
  
  if [ "$TRAVIS_TAG" = "" ]; then
    echo "‚ö†Ô∏è  WARNING: No tag present - deployment might be skipped"
  fi
  
  function npm_dist_tag() {
    if [[ "$TRAVIS_TAG" = *"beta"* ]]; then
      echo "beta"
    else
      echo "latest"
    fi
  }
  
  echo "NPM dist tag will be: $(npm_dist_tag)"
  echo "=== END DEPLOYMENT DEBUG INFO ==="

deploy:
  skip_cleanup: true
  provider: npm
  tag: $(npm_dist_tag)
  email: e2@leanplum.com
  api_key:
    secure: FPGbRrqVHHpBcAL87NZX5aDNBIYUEBRUZO/b63Q4MCi027XV3TRNQcnx86Ad+OPgA3rJJilUG9O0WxtTj8OqMK0jZTrwv0AWqdvPIcGNENaWg1NHu8YznRtMaEC3yph0Prhtc0RdiwIoxnNCfZ1dmUGGk1+mLeGImMv6MOi1TchJlB5xNZqb/nfA1X1NM0HIqDP2YpxjIfJl6Vp14EXCmy8tkX2+Aq912W2AVKIPLMoPgfP3sXs6LZ1J3PIPTMxqZgoqxyGwWPavrBxGKe8aiIpnouAVIyv9J+7MNTh0hjF5wq+AoxA0Neu6lbQY/cqxt4A6YPZOy5sHE5XIGytXg9CMw4gMVU+SDlZVTyb1K16zrr6gao8E+JdPDV3k7v3L59pAwzWeAKoU/V1ic+0WOEukTJaa2rYuCL4F7jOwmMcuLDTsP4QQrznmXXRVcRviIWywVnVPJWqJFt6T5Zi82qVp7cjLmn6E9QYKSkBdeA4SA+VrdTx3C5AXHRccHdd5hvozrOOG1GBExMwtg88HSw6rWMmWFLGqrYuVxHnMU8/btZYIlhjPpLYbVmIibmb+6o0FxWRPyk6jCsftdqiOUm80FZJosPp4FOlM7TOss1bY4lSzH0t/vdXNDVsgUym6cOHZFfYiIo3hLOYXXOq9peyb5OqSKcmkDsMc7nOvyCg=
  on:
    repo: Leanplum/Leanplum-ReactNative-SDK
    tags: true
